# 要件定義書：売上計算ソフト

## 1. 概要

本ソフトウェアは、CSVファイル及び手動入力された売上データを解析し、決済ツールごとの売上集計、マーケティング指標の算出、およびデータ精査を支援するためのWebアプリケーションである。

## 2. 機能要件

### 2.1. データ入力機能

#### 2.1.1. CSVファイルのインポート
- ユーザーは、Web UIを介してCSVファイルをアップロードできる。
  - ファイル選択ダイアログからの選択。
  - ドラッグ＆ドロップによるアップロード。
- **CSVフォーマット:**
  - **文字コード:** UTF-8
  - **必須列:** `金額`, `決済方法`, `決済ツール名`
  - **ヘッダー:** 1行目にヘッダー行が存在すること。

#### 2.1.2. 手動での伝票入力
- Web UI上のフォームから、個別の伝票データを手動で登録できる。
- **入力項目:**
  - 伝票番号 (任意)
  - 名前 (任意)
  - 金額 (必須)
  - 決済ツール (必須、ドロップダウンから選択)
  - 内容・メモ (任意)
- **決済ツールの選択肢:**
  - `Waon`, `信州割`, `その他`, `Cash`, `Credit Card`, `Pay Pay`, `R Pay`, `AU Pay`, `R Edy`, `ID`, `QUIC Pay`, `交通系`, `ふるさと納税`, `NANACO`

### 2.2. 売上集計・分析機能

#### 2.2.1. 売上集計
- インポートしたCSVデータと手動入力した伝票データの両方を合算して集計する。
- `決済ツール名` ごとに `金額` を合計する。
- **特別ルール:**
  - CSVデータにおいて `決済方法` が「カード払い」の場合、`決済ツール名` を「事前カード」として扱う。

#### 2.2.2. 決済ツールのグルーピング
- 特定の決済ツールを定義済みのカテゴリに分類し、カテゴリごとの小計を表示する。
- **楽天カテゴリ:**
  - **アプリ決済:** `R Pay`, `AU Pay`
  - **タッチ決済:** `ID`, `R Edy`, `QUIC Pay`, `交通系`, `NANACO`
  - **クレジットカード:** `Credit Card`

#### 2.2.3. 決済ツール不明データの処理
- CSVデータにおいて `決済ツール名` が空欄の取引は「不明」として分類する。
- 不明データは、`申込番号` でグルーピングされ、同じ申込番号を持つ取引の合計金額が `枝番` '1' の行に表示される。

#### 2.2.4. マーケティング指標の算出
- 全データ（CSV + 手動入力）を基に、以下の指標を自動で計算する。
  - **総売上:** 全取引の合計金額。
  - **総取引件数:** ユニークな `申込番号` の総数。
  - **ユニーク顧客数:** ユニークな `お名前` の総数。
  - **平均取引単価:** 総売上 ÷ 総取引件数。
  - **顧客平均単価:** 総売上 ÷ ユニーク顧客数。
  - **決済方法別サマリー:** `決済方法` ごとの売上合計と取引件数。

### 2.3. 表示機能

- 全ての集計・分析結果は、単一のWebページ内に複数のセクションとして表示される。

#### 2.3.1. 決済サマリー表示
- 決済ツールごとの売上をテーブル形式で表示する。
- 「楽天」カテゴリは、大分類・中分類（アプリ決済など）・小分類（R Payなど）の階層構造で表示する。
- 全ての売上の総合計を表示する。

#### 2.3.2. 手動伝票リスト表示
- 登録された手動伝票を一覧テーブルで表示する。
- 各伝票には「編集」「削除」ボタンが付属する。

#### 2.3.3. 決済ツール不明リスト表示
- 決済ツールが不明な取引を一覧テーブルで表示する。
- 各行にチェックボックスを設け、ユーザーが確認済みの行を視覚的にマークできる（チェックした行は背景色が変わる）。

#### 2.3.4. マーケティング指標表示
- 算出されたマーケティング指標をテーブル形式で表示する。

### 2.4. 手動伝票管理機能
- ユーザーは登録済みの手動伝票に対して以下の操作を行える。
  - **編集:** 各項目（伝票番号、名前、金額など）を更新できる。
  - **削除:** 伝票をリストから削除できる。確認ダイアログを表示する。

## 3. 非機能要件

### 3.1. ユーザビリティ
- 単一ページ内で全ての操作と確認が完結し、直感的に利用できるUIを提供する。
- 処理の実行やエラー発生時には、適切なフィードバック（メッセージ表示など）を返す。

### 3.2. エラーハンドリング
- **CSVインポート時:**
  - 必須列が存在しない場合、エラーメッセージを表示する。
  - ファイル形式がCSVでない場合、エラーメッセージを表示する。
- **手動入力時:**
  - 金額が有効な数値でない場合、登録を防止する。

## 4. 開発環境・技術スタック

- **フレームワーク:** Next.js
- **言語:** JavaScript
- **主要ライブラリ:** React, PapaParse (CSV解析)
- **実行環境:** Node.js, Webブラウザ
